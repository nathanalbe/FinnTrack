<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Manage Budget{% endblock %} - Finance App</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="{{ url_for('home') }}">Finance App</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          {% if current_user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('budget') }}">Budget</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('spending') }}">Spending</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('login') }}">Login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('register') }}">Register</a>
          </li>
          {% endif %}
        </ul>
      </div>
    </nav>

    <div class="container mt-4">
      <h1>Manage Budget</h1>
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
          {{ form.name.label(class="form-control-label") }} {{
          form.name(class="form-control") }}
        </div>
        <div class="form-group">
          {{ form.amount.label(class="form-control-label") }} {{
          form.amount(class="form-control") }}
        </div>
        <div class="form-group">{{ form.submit(class="btn btn-primary") }}</div>
      </form>
      <hr />
      <h2>Your Budgets</h2>
      <ul>
        {% for budget in budgets %}
        <li>
          {{ budget.name }}: ${{ budget.amount }}
          <a
            href="{{ url_for('update_budget', budget_id=budget.id) }}"
            class="btn btn-secondary btn-sm"
            >Edit</a
          >
          <form
            action="{{ url_for('delete_budget', budget_id=budget.id) }}"
            method="POST"
            style="display: inline"
          >
            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
          </form>
        </li>
        {% endfor %}
      </ul>
      <hr />
      <button id="linkButton" class="btn btn-primary">
        Link your bank account
      </button>
      <h2>Your Transactions</h2>
      <ul id="transactionsList">
        <!-- Transactions will be populated here -->
      </ul>

      <script>
        document.getElementById("linkButton").onclick = function () {
          fetch("/create_link_token", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (data) {
              var linkHandler = Plaid.create({
                token: data.link_token,
                onSuccess: function (public_token, metadata) {
                  // Send the public_token to your server
                  fetch("/exchange_public_token", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      public_token: public_token,
                    }),
                  })
                    .then(function (response) {
                      return response.json();
                    })
                    .then(function (data) {
                      console.log(
                        "Public token exchanged for access token",
                        data
                      );
                      // Fetch transactions after getting the access token
                      fetchTransactions();
                    });
                },
                onExit: function (err, metadata) {
                  console.log("User exited Plaid Link:", err, metadata);
                },
              });

              linkHandler.open();
            });
        };

        function fetchTransactions() {
          fetch("/transactions", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (data) {
              var transactionsList =
                document.getElementById("transactionsList");
              transactionsList.innerHTML = "";
              data.transactions.forEach(function (transaction) {
                var li = document.createElement("li");
                li.textContent =
                  transaction.date +
                  ": " +
                  transaction.name +
                  " - $" +
                  transaction.amount;
                transactionsList.appendChild(li);
              });
            });
        }
      </script>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html>
